<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PREDICT — Avan data portal</title>
  <style>
    :root {
      --brand-primary: #002F6C;
      --brand-secondary: #7A9AAE;
      --brand-accent: #E6B800;
      --text: #222;
      --muted: #666;
      --bg: #fff;
      --soft: #f6f8fa;
      --border: #e1e4e8;
      --chip-bg: #eef6ff;
      --chip-border: #cfe2ff;
    }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin:0; color:var(--text); background:var(--bg); }
    header { background: var(--brand-primary); color: white; padding: 1.5rem 1rem; }
    header .container { max-width: 1200px; margin: 0 auto; }
    h1 { margin: 0; font-weight: 700; letter-spacing: 0.3px; }
    .subtitle { margin-top: 0.25rem; color: #dfe7f2; }
    main { max-width: 1200px; margin: 1.25rem auto; padding: 0 1rem 3rem; }

    .introduction { background: #fff; border: 1px solid var(--border); border-radius: 10px; padding: 1rem; margin: 1rem 0 1.25rem; }
    .introduction h1, .introduction h2, .introduction h3 { color: var(--brand-primary); }

    .dataset-card { border: 1px solid var(--border); border-radius: 10px; background: var(--soft); margin-bottom: 1.25rem; overflow: hidden; }
    .dataset-header { padding: 1rem 1rem 0.75rem; border-bottom: 1px solid var(--border); background: #fff; }
    .dataset-title { margin: 0; color: var(--brand-primary); }
    .dataset-subtitle { margin: 0.2rem 0 0.4rem; color: var(--muted); font-size: 0.95rem; }
    .dataset-info { font-size: 0.95rem; color: #333; }
    .dataset-info p { margin: 0.25rem 0; }
    .dataset-info code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background: #f1f3f5; padding: 0 .25rem; border-radius: 4px; }

    .dataset-toggle-wrap { padding: 0.8rem 1rem; background: var(--soft); border-bottom: 1px solid var(--border); }
    .dataset-body.is-collapsed { display: none; }

    .controls { display: flex; gap: 0.75rem; align-items: center; padding: 0.8rem 1rem; background: var(--soft); border-bottom: 1px solid var(--border); }
    .controls input[type="search"], .controls select { padding: 0.55rem 0.7rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.95rem; background: #fff; }
    .controls input[type="search"] { flex: 1; }
    .controls .info { color: var(--muted); font-size: 0.9rem; }

    .table-wrap { overflow-x: auto; background:#fff; }
    table { width: 100%; border-collapse: collapse; background: #fff; }
    thead th { text-align: left; font-weight: 600; font-size: 0.9rem; color: var(--muted); padding: 0.6rem 0.7rem; border-bottom: 1px solid var(--border); background: #fafbfc; }
    tbody td { padding: 0.6rem 0.7rem; border-bottom: 1px solid var(--border); vertical-align: top; }
    tbody tr:hover { background: #fcfcfd; }
    .var-label { font-weight: 600; }
    .var-notes-preview { color: var(--muted); font-size: 0.9rem; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; margin-bottom: 0.25rem; }
    .var-notes-full { color: var(--muted); font-size: 0.9rem; margin-top: 0.5rem; white-space: pre-wrap; word-break: break-word; }
    .var-notes-toggle { background: none; border: none; color: var(--brand-primary); cursor: pointer; font-size: 0.9rem; padding: 0; margin-top: 0.25rem; text-decoration: underline; }
    .var-notes-toggle:hover { text-decoration: none; font-weight: 600; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 0.9rem; }

    .chips { display: flex; flex-wrap: wrap; gap: 4px; }
    .chip { display: inline-flex; align-items: center; gap: 6px; padding: 2px 8px; border-radius: 999px; border: 1px solid var(--chip-border); background: var(--chip-bg); font-size: 12px; color: #0f3b74; }

    .cart { position: sticky; top: 0; z-index: 2; background: #fff; border-bottom: 1px solid var(--border); }
    .cart .container { max-width: 1200px; margin: 0 auto; padding: 0.5rem 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem 1rem; align-items: center; }
    .tag { background: var(--soft); border: 1px solid var(--border); border-radius: 999px; padding: 0.25rem 0.6rem; font-size: 0.85rem; }
    .btn { appearance: none; background: var(--brand-primary); color:#fff; border: none; border-radius: 6px; padding: 0.5rem 0.8rem; cursor: pointer; }
    .btn.secondary { background: var(--brand-secondary); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    footer { max-width: 1200px; margin: 2rem auto; padding: 0 1rem 3rem; color: var(--muted); font-size: 0.9rem; }
    footer details { cursor: pointer; }
    footer details summary { user-select: none; font-weight: 600; }
    footer details summary:hover { color: var(--text); }
    footer details[open] summary { margin-bottom: 0.5rem; }
    footer pre { background: var(--soft); border: 1px solid var(--border); border-radius: 6px; padding: 0.8rem; overflow-x: auto; }
    @media(max-width:640px){ /* compact layout adjustments */ }
    /* Sidebar TOC styles */
    .app-layout { display: flex; gap: 1rem; align-items: flex-start; }
    .content { flex: 1; }
    .toc { width: 260px; position: sticky; top: 5.5rem; padding-left: 1rem; max-height: calc(100vh - 7rem); overflow: auto; border-left: 1px solid var(--border); }
    .toc h3 { margin: 0 0 0.5rem 0; font-size: 0.95rem; color: var(--brand-primary); }
    .toc ul { list-style: none; padding: 0; margin: 0; }
    .toc li { margin: 0.25rem 0; }
    .toc a { color: var(--muted); text-decoration: none; font-size: 0.95rem; }
    .toc a.active { color: var(--brand-primary); font-weight: 700; }
    @media(max-width:900px){ .toc { display: none; } }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>PREDICT</h1>
      <div class="subtitle">Avan data portal</div>
    </div>
  </header>

  <div class="cart">
      <div class="container">
      <strong>Selected variables:</strong>
      <span id="cart-count" class="tag">0</span>
      <button id="download-csv" class="btn" disabled>Download CSV</button>
      <button id="clear-selection" class="btn secondary" disabled>Clear</button>
      <span class="hide-sm" style="color:var(--muted)">Selections persist during this session only.</span>
      
    </div>
  </div>

  <main>
    {% if intro_html %}
    <section class="introduction">
      {{ intro_html | safe }}
    </section>
    {% endif %}

    <div class="app-layout">
      <div id="app" class="content"></div>
      <aside id="sidebar-toc" class="toc" aria-label="Datasets Table of Contents">
        <h3>Contents</h3>
        <ul></ul>
      </aside>
    </div>
  </main>

  <script id="dataset-json" type="application/json">{{ data_json | safe }}</script>

  <script>
  (function(){
    const state = { datasets: [], selected: new Map() };
    const $ = (s,r=document)=>r.querySelector(s);
    const $all = (s,r=document)=>Array.from(r.querySelectorAll(s));

    function parseData(){ try{ return JSON.parse($('#dataset-json').textContent.trim())||[] }catch(e){ return []; } }
    function escapeHTML(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }
    function csvEscape(v){ const s=String(v).replace(/\r?\n/g,' '); return (s.includes(',')||s.includes('"'))? '"'+s.replace(/"/g,'""')+'"': s; }

    // --- Inline Markdown renderer for descriptions ---
    // Supports: [text](url), `code`, **strong**, *em*, __strong__, _em_, ~~del~~, and auto-linking bare URLs.
    function markdownToHtml(input){
      if (input == null) return '';
      let html = String(input);

      // Links [text](url)
      html = html.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, (m, text, url) =>
        `<a href="${url}" target="_blank" rel="noopener">${escapeHTML(text)}</a>`);

      // Inline code
      html = html.replace(/`([^`]+)`/g, (m, code) => `<code>${escapeHTML(code)}</code>`);

      // Strong first, then em
      html = html.replace(/\*\*(?=\S)(.+?)(?<=\S)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/__(?=\S)(.+?)(?<=\S)__/g, '<strong>$1</strong>');
      html = html.replace(/(?<!\*)\*(?=\S)(.+?)(?<=\S)(?<!\*)\*/g, '<em>$1</em>');
      html = html.replace(/_(?=\S)(.+?)(?<=\S)_/g, '<em>$1</em>');
      html = html.replace(/~~(?=\S)(.+?)(?<=\S)~~/g, '<del>$1</del>');

      // Auto-link bare URLs (avoid already linked)
      html = html.replace(/(^|[\s(>])((https?:\/\/[^\s<>"')]+))(?=[\s<)"']|$)/g,
        (m, pre, url) => `${pre}<a href="${url}" target="_blank" rel="noopener">${url}</a>`);

      return html;
    }

    function splitMarkdownParagraphs(md){
      // Split on blank lines into paragraphs; keep single newlines within a paragraph
      return String(md).trim().split(/\n\s*\n/);
    }

    function splitNotesPreviewAndDetails(notes){
      // Split notes into preview (first 3 lines) and details (rest)
      const lines = String(notes).split('\n');
      if (lines.length <= 3) return { preview: notes, details: null };
      const preview = lines.slice(0, 3).join('\n');
      const details = lines.slice(3).join('\n');
      return { preview, details };
    }

    function toCSVRecord(ds,v){ return {
      dataset_id:ds.id,
      dataset_title:ds.title||ds.id,
      variable_name:v.name,
      label:v.label||'',
      source_variable_name:v.source||'',
      type:v.type||'',
      category:(v.categories||[]).join('|'),
      notes:v.notes||''
    }; }

    function computeCategoryCounts(ds){
      const m=new Map();
      // Prefer full var map (includes hidden members) when available
      const allVars = ds.var_map_all || ds.var_map || {};
      for(const v of Object.values(allVars)){
        for(const c of (v.categories||[])){ m.set(c,(m.get(c)||0)+1); }
      }
      return Array.from(m.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
    }

    function isGroup(v){ return !!v.is_group; }
    function isGroupFullySelected(ds, group){
      // If group is exported as a single CSV row, consider it selected when
      // the group key is present. Otherwise require all members selected.
      if (group.csv_expand === 'group'){
        return state.selected.has(ds.id+'::'+group.name);
      }
      return (group.members||[]).every(name => state.selected.has(ds.id+'::'+name));
    }
    function selectGroup(ds, group){
      if (group.csv_expand === 'group'){
        state.selected.set(ds.id+'::'+group.name, toCSVRecord(ds, group));
        return;
      }
      (group.members||[]).forEach(name=>{
        const leaf = (ds.var_map_all||ds.var_map||{})[name];
        if(leaf){ state.selected.set(ds.id+'::'+name, toCSVRecord(ds, leaf)); }
      });
    }
    function deselectGroup(ds, group){
      if (group.csv_expand === 'group'){
        state.selected.delete(ds.id+'::'+group.name);
        return;
      }
      (group.members||[]).forEach(name=> state.selected.delete(ds.id+'::'+name));
    }

    function render(){
      const app = document.getElementById('app');

      state.datasets.forEach(ds => {
        const section = document.createElement('section');
        section.className='dataset-card'; section.dataset.datasetId = ds.id; section.id = ds.id;

        // Header with description: prefer info_md; else fall back to info[]
        const header = document.createElement('div'); header.className='dataset-header';

        let infoHTML = '';
        if (ds.info_md && String(ds.info_md).trim()){
          const paras = splitMarkdownParagraphs(ds.info_md);
          infoHTML = `<div class="dataset-info">${
            paras.map(p => `<p>${markdownToHtml(p)}</p>`).join('')
          }</div>`;
        } else if (Array.isArray(ds.info) && ds.info.length){
          infoHTML = `<div class="dataset-info">${
            ds.info.map(p => `<p>${markdownToHtml(p)}</p>`).join('')
          }</div>`;
        }

        header.innerHTML=`
          <h2 class="dataset-title">${escapeHTML(ds.title||ds.id)}</h2>
          ${ds.subtitle?`<div class="dataset-subtitle">${escapeHTML(ds.subtitle)}</div>`:''}
          ${infoHTML}`;
        section.appendChild(header);

        // Toggle button below description, above filters/table
        const toggleWrap = document.createElement('div'); toggleWrap.className='dataset-toggle-wrap';
        toggleWrap.innerHTML = `
          <button class="btn dataset-toggle"
                  data-role="toggle-dataset"
                  data-dataset-id="${escapeHTML(ds.id)}"
                  aria-expanded="false">
            Show variables
          </button>`;
        section.appendChild(toggleWrap);

        // Collapsible body: controls + table (hidden initially)
        const body = document.createElement('div'); body.className='dataset-body is-collapsed'; body.id = `body-${ds.id}`;

        const controls = document.createElement('div'); controls.className='controls';
        controls.innerHTML=`
          <input type="search" placeholder="Search… (label, variable, notes)" aria-label="Search variables">
          <select data-role="filterCat" aria-label="Filter by category"><option value="">All categories</option></select>
          <div class="info">${ds.variables.length} items</div>`;
        body.appendChild(controls);

        const tableWrap = document.createElement('div'); tableWrap.className='table-wrap';
        tableWrap.innerHTML=`
          <table>
            <thead><tr>
              <th style="width:2rem"><input type="checkbox" data-action="toggle-all"></th>
              <th>Label</th>
              <th class="hide-sm">Variable name</th>
              <th class="hide-sm">Source variable name</th>
              <th class="hide-sm">Type</th>
              <th class="hide-sm">Categories</th>
            </tr></thead>
            <tbody></tbody>
          </table>`;
        body.appendChild(tableWrap);

        section.appendChild(body);

        // Populate category filter
        const catCounts = computeCategoryCounts(ds);
        const ddl = controls.querySelector('select[data-role="filterCat"]');
        for(const [cat,_] of catCounts){ const opt=document.createElement('option'); opt.value=cat; opt.textContent=cat; ddl.appendChild(opt); }

        // Render variable rows
        const tbody = body.querySelector('tbody');
        ds.variables.forEach(v=>{
          v._search = [v.label, v.name, v.notes, ...(v.members||[])].filter(Boolean).join(' ');
          tbody.appendChild(renderRow(ds, v));
        });

        // Wire search/filter
        const search = controls.querySelector('input[type="search"]');
        search.addEventListener('input', ()=>applyFilter(section, ds));
        ddl.addEventListener('change', ()=>applyFilter(section, ds));

        // Select-all (visible rows only)
        body.querySelector('[data-action="toggle-all"]').addEventListener('change', (e)=>{
          const rows = $all('tbody tr', body).filter(r=>r.style.display!=='none');
          rows.forEach(r=>{
            const cb=r.querySelector('input[type="checkbox"]');
            cb.checked=e.target.checked;
            cb.dispatchEvent(new Event('change'));
          });
        });

        // Toggle behavior
        const btn = toggleWrap.querySelector('button[data-role="toggle-dataset"]');
        btn.addEventListener('click', ()=>{
          const expanded = btn.getAttribute('aria-expanded') === 'true';
          const next = !expanded;
          btn.setAttribute('aria-expanded', String(next));
          btn.textContent = next ? 'Hide variables' : 'Show variables';
          body.classList.toggle('is-collapsed', !next);
        });

        app.appendChild(section);
      });

      updateCartUI();
    }

    function renderRow(ds, v){
      const tr = document.createElement('tr');
      const key = ds.id+'::'+v.name;
      tr.dataset.key = key;

      const labelText = v.is_group ? `${v.label} (${(v.members||[]).length} fields)` : (v.label || v.name);
      const catsHTML = `<div class="chips">${(v.categories||[]).map(c=>`<span class="chip">${escapeHTML(c)}</span>`).join('')}</div>`;

      tr.innerHTML = `
        <td><input type="checkbox" aria-label="Select ${escapeHTML(labelText)}"></td>
        <td>
          <div class="var-label">${escapeHTML(labelText)}</div>
          <div class="var-notes-container"></div>
        </td>
        <td class="mono hide-sm">${escapeHTML(v.name)}</td>
        <td class="mono hide-sm">${escapeHTML(v.source||'')}</td>
        <td class="hide-sm">${escapeHTML(v.type||'')}</td>
        <td class="hide-sm">${catsHTML}</td>`;

      // Add notes after rendering (use backend flag `notes_is_long` when present)
      if (v.notes) {
        const notesContainer = tr.querySelector('.var-notes-container');

        const previewDiv = document.createElement('div');
        previewDiv.className = 'var-notes-preview';
        previewDiv.textContent = v.notes;
        notesContainer.appendChild(previewDiv);

        // If backend marked notes as long, render expandable full text + toggle
        if (v.notes_is_long) {
          const fullDiv = document.createElement('div');
          fullDiv.className = 'var-notes-full';
          fullDiv.style.display = 'none';
          fullDiv.textContent = v.notes;

          const toggleBtn = document.createElement('button');
          toggleBtn.className = 'var-notes-toggle';
          toggleBtn.textContent = 'More\u2026';

          let isExpanded = false;
          toggleBtn.addEventListener('click', (e)=>{
            e.preventDefault();
            e.stopPropagation();
            isExpanded = !isExpanded;
            if (isExpanded) {
              previewDiv.style.display = 'none';
              fullDiv.style.display = 'block';
              toggleBtn.textContent = 'Less';
            } else {
              previewDiv.style.display = '-webkit-box';
              fullDiv.style.display = 'none';
              toggleBtn.textContent = 'More\u2026';
            }
          });

          notesContainer.appendChild(fullDiv);
          notesContainer.appendChild(toggleBtn);
        }
      }

      const cb = tr.querySelector('input[type="checkbox"]');
      if (v.is_group) cb.checked = isGroupFullySelected(ds, v); else cb.checked = state.selected.has(key);

      cb.addEventListener('change', ()=>{
        if (v.is_group){
          if (cb.checked) selectGroup(ds, v); else deselectGroup(ds, v);
        } else {
          if (cb.checked) state.selected.set(key, toCSVRecord(ds, v)); else state.selected.delete(key);
        }
        updateCartUI();
        // Refresh group checkboxes in this dataset
        const rows = $all('tbody tr', tr.closest('section'));
        rows.forEach(row=>{
          const k = row.dataset.key; const vv = (ds._byRow||{})[k];
          if (vv && vv.is_group){ const c = row.querySelector('input[type="checkbox"]'); c.checked = isGroupFullySelected(ds, vv); }
        });
      });

      ds._byRow = ds._byRow || {}; ds._byRow[key] = v;
      return tr;
    }

    function applyFilter(section, ds){
      const q = section.querySelector('input[type="search"]').value.trim().toLowerCase();
      const cat = section.querySelector('select[data-role="filterCat"]').value;
      const rows = $all('tbody tr', section);
      rows.forEach(r=>{
        const v = (ds._byRow||{})[r.dataset.key];
        const blob = (v._search||'').toLowerCase();
        const hit = !q || blob.includes(q);
        const catOk = !cat
          || (v.categories||[]).includes(cat)
          || (v.is_group && (v.members||[]).some(name => (ds.var_map[name]||{}).categories?.includes(cat)));
        r.style.display = (hit && catOk) ? '' : 'none';
      });
      section.querySelector('[data-action="toggle-all"]').checked = false;
    }

    function updateCartUI(){
      const n = state.selected.size; document.getElementById('cart-count').textContent=String(n);
      document.getElementById('download-csv').disabled = n===0; document.getElementById('clear-selection').disabled = n===0;
    }

    function downloadCSV(){
      const rows = Array.from(state.selected.values()); if (!rows.length) return;
      const headers=['dataset_id','dataset_title','variable_name','label','source_variable_name','type','category','notes'];
      const csv=[headers.join(',')]
        .concat(rows.map(r=>headers.map(h=>csvEscape(r[h]??'')).join(',')))
        .join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download='predict_variables.csv';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    function clearSelection(){
      state.selected.clear();
      document.querySelectorAll('tbody input[type="checkbox"]').forEach(cb=>cb.checked=false);
      updateCartUI();
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      state.datasets = parseData();
      state.datasets.forEach(ds=>{ ds.var_map = ds.var_map || {}; });
      render();
      document.getElementById('download-csv').addEventListener('click', downloadCSV);
      document.getElementById('clear-selection').addEventListener('click', clearSelection);
      // Build dataset index for navigation and TOC
      const dsIndex = state.datasets.map(d=>({id:d.id,title:d.title||d.id,subtitle:d.subtitle||''}));

      function jumpToDataset(id){
        if(!id) return;
        const el = document.getElementById(id); if(!el) return;
        const topBar = document.querySelector('.cart');
        const offset = topBar ? Math.ceil(topBar.getBoundingClientRect().height) + 8 : 16;
        const top = el.getBoundingClientRect().top + window.scrollY - offset;
        window.scrollTo({ top, behavior: 'smooth' });
      }

      // Populate sidebar TOC and highlight on scroll
      const toc = document.getElementById('sidebar-toc');
      const tocList = toc.querySelector('ul');
      dsIndex.forEach(d=>{
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = '#'+d.id; a.textContent = d.title || d.id; a.dataset.targetId = d.id;
        a.addEventListener('click', (ev)=>{ ev.preventDefault(); jumpToDataset(d.id); });
        li.appendChild(a); tocList.appendChild(li);
      });

      // Highlight active section using IntersectionObserver
      try{
        const observer = new IntersectionObserver((entries)=>{
          entries.forEach(entry=>{
            const id = entry.target.id; const link = toc.querySelector(`a[data-target-id="${id}"]`);
            if(entry.isIntersecting){ toc.querySelectorAll('a').forEach(x=>x.classList.remove('active')); if(link) link.classList.add('active'); }
          });
        }, { root: null, rootMargin: '-20% 0px -60% 0px', threshold: 0 });
        dsIndex.forEach(d=>{ const el = document.getElementById(d.id); if(el) observer.observe(el); });
      }catch(e){ /* IntersectionObserver not available -> no highlighting */ }
    });

  })();
  </script>

  <footer>
    <details>
      <summary>Provenance</summary>
      <p>Generated from YAML sources. Input files and hash:</p>
      <pre style="white-space: pre-wrap; word-break: break-word;">{{ provenance | e }}</pre>
    </details>
  </footer>

</body>
</html>
